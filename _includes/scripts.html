<script type="module" src="{{ base_path }}/assets/js/main.min.js"></script>
<script nomodule src="{{ base_path }}/assets/js/main.min.js"></script>
{% include analytics.html %}

<script>
document.addEventListener("DOMContentLoaded", function() {
    const toggleBtn = document.getElementById("theme-toggle");
    const themeIcon = document.getElementById("theme-icon");
    const contentWrapper = document.getElementById("main-content-wrapper");
    //  关键：获取 html 标签
    const htmlEl = document.documentElement;
    const bodyEl = document.body;

    // --- A. 初始化状态同步 ---
    // 因为 head 里已经设置了 html 的 class，这里主要是同步图标和 body
    if (htmlEl.classList.contains("dark") || localStorage.getItem("theme") === "dark") {
        htmlEl.classList.add("dark"); // 确保 html 有
        bodyEl.classList.add("dark"); // body 也加上（双重保险）
        if(themeIcon) { themeIcon.classList.remove("fa-sun"); themeIcon.classList.add("fa-moon"); }
    }

    // --- B. 滚动特效 (保持不变) ---
    function updateBackground() {
        if (!contentWrapper) return;
        var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        var opacity = Math.min(scrollTop / 500, 0.95);
        // 判断依据：查 html 标签
        var isDark = htmlEl.classList.contains("dark");

        if (isDark) {
            contentWrapper.style.backgroundColor = "rgba(0, 0, 0, " + opacity + ")";
            contentWrapper.style.backdropFilter = "blur(" + (opacity * 15) + "px)"; 
        } else {
            contentWrapper.style.backgroundColor = "rgba(255, 255, 255, " + opacity + ")";
            contentWrapper.style.backdropFilter = "blur(" + (opacity * 10) + "px)";
        }
    }
    window.addEventListener("scroll", updateBackground);
    updateBackground();

    // --- C. 点击切换逻辑 (同步切换 html 和 body) ---
    if (toggleBtn) {
        toggleBtn.addEventListener("click", function(e) {
            e.preventDefault();
            
            //  同时切换两个地方
            htmlEl.classList.toggle("dark");
            bodyEl.classList.toggle("dark");
            
            var isDark = htmlEl.classList.contains("dark");

            if (isDark) {
                localStorage.setItem("theme", "dark");
                if(themeIcon) { themeIcon.classList.remove("fa-sun"); themeIcon.classList.add("fa-moon"); }
            } else {
                localStorage.setItem("theme", "light");
                if(themeIcon) { themeIcon.classList.remove("fa-moon"); themeIcon.classList.add("fa-sun"); }
            }
            updateBackground();
        });
    }
});
</script>
